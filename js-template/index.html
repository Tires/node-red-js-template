<script type="text/javascript">
    RED.nodes.registerType("JS Template", {
        category: "function",
        color: "#d28b5c",
        defaults: {
            name: { value: "" },
            entries: [{
                property: "payload",
                template: "",
                type: "text"
            }]
        },
        inputs: 1,
        outputs: 1,
        icon: "js-template.svg",
        label: function() {
            return this.name || "JS Template";
        },
        oneditprepare: function() {
            let node = this;

            function addRow(entry = { property: "payload", template: "", type: "text" }) {
                let index = $("#node-input-entries-container .form-row").length;
                let row = $("<div/>", {
                        class: "form-row"
                    })
                    .appendTo("#node-input-entries-container");

                $("<input/>", {
                        type: "text",
                        class: "node-input-property",
                        style: "width: 40%;",
                        placeholder: "payload"
                    }).val(entry.property).appendTo(row);
                $("<select/>", {
                        class: "node-input-type",
                        style: "width: 40%; margin-left: 5px;"
                    })
                    .append($("<option/>", { value: "text", text: "Text" }))
                    .append($("<option/>", { value: "JSON", text: "JSON" }))
                    .val(entry.type || "text").appendTo(row);

                $("<textarea/>", {
                        class: "node-input-template",
                        rows: 20,
                        style: "width: 100%; margin-top: 3px;",
                        placeholder: "{{ payload }}"
                    }).val(entry.template).appendTo(row);

                if (index > 0) {
                    $("<button/>", {
                            class: "red-ui-button red-ui-button-small",
                            text: "❌",
                            style: "position: absolute; margin-top: 8px; right: 26px;"
                        })
                        .appendTo(row)
                        .click(function() {
                            row.remove();
                        });
                }
            }

            let container = $("#node-input-entries-container").empty();
            (node.entries || [{ property: "payload", template: "", type: "text" }]).forEach(entry => addRow(entry));

            $("#node-input-add-entry").off("click").on("click", function() {
                addRow();
            });
        },
        oneditsave: function() {
            let entries = [];
            $("#node-input-entries-container .form-row").each(function() {
                let property = $(this).find(".node-input-property").val();
                let type = $(this).find(".node-input-type").val();
                let template = $(this).find(".node-input-template").val();
                entries.push({ property, type, template });
            });
            this.entries = entries;
        }
    });
</script>

<script type="text/x-red" data-template-name="JS Template">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" style="width: 100%;">
    </div>
    <div class="form-row">
        <h3 for="node-input-entries-container">Entries</h3>
        <div id="node-input-entries-container"></div>
        <button id="node-input-add-entry" class="red-ui-button" style="margin-top: 10px; display: block;">➕</button>
    </div>
</script>

<script type="text/x-red" data-help-name="JS Template">
    <p>This node implements a JS template.</p>
</script>
